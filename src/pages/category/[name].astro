---
import CategoryTab from "@/components/CategoryTab.astro";
import Title from "@/components/Title.astro";
import Layout from "@/layouts/Layout.astro"
import { getCategories, getWorks } from "@/libs/microcms";

export async function getStaticPaths() {
  const res = await getCategories({
    fields: "name"
  })

  return res.contents.map(({ name }) => ({
    params: {
      name
    }
  }))
}

const { name } = Astro.params;

const categories = await getCategories({
  limit: 100
})

const currentCategory = categories.contents.find(category => category.name === name)
if (!currentCategory) {
  throw new Error("カテゴリーが見つかりません")
}

const works = await getWorks({
  fields: ["id", "title"],
  filters: `category[equals]${currentCategory?.id}`,
  orders: "-createdAt",
  limit: 100,
});
---

<Layout title={name || "untitled"}>
  <Title title="works" />
  <CategoryTab current={currentCategory.name} contents={categories.contents} />
  <div>
    {
      works.contents.map(({ id, title }) => (
        <a href={`/works/${id}`}>{title}</a>
      ))
    }
  </div>
</Layout>
